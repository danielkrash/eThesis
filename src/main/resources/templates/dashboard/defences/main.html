<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/layout :: head}"></head>
<body class="d-flex flex-column min-vh-100">
    <!-- Header -->
    <header th:replace="~{fragments/layout :: header}"></header>

    <!-- Main Content -->
    <main class="flex-grow-1">
        <div class="container mt-4">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <h2 class="display-6 fw-bold text-primary">
                        <i class="bi bi-shield-check me-3"></i>Defense Management
                    </h2>
                    <p class="text-muted">
                        Schedule defense dates and manage thesis defenses
                    </p>
                </div>
            </div>

                <!-- Alert Messages -->
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span th:text="${success}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <span th:text="${error}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Create Defense Date Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-calendar-plus me-2"></i>Create Defense Date
                        </h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/dashboard/defences/create}" method="post">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="date" class="form-label">Defense Date</label>
                                    <input type="date" class="form-control" id="date" name="date" required
                                           th:min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}">
                                </div>
                                <div class="col-md-4">
                                    <label for="location" class="form-label">Location</label>
                                    <input type="text" class="form-control" id="location" name="location" 
                                           placeholder="e.g., Room 305, Building A" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="departmentIds" class="form-label">Departments</label>
                                    <select class="form-select" id="departmentIds" name="departmentIds" multiple required>
                                        <option th:each="dept : ${departments}" 
                                                th:value="${dept.id}" 
                                                th:text="${dept.name}">Department Name</option>
                                    </select>
                                    <div class="form-text">Hold Ctrl/Cmd to select multiple departments</div>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-plus-circle me-1"></i>Create
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Defense Dates List -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-calendar-event me-2"></i>Upcoming Defense Dates
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${#lists.isEmpty(futureDefenses)}" class="text-center py-4">
                            <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">No upcoming defense dates scheduled.</p>
                        </div>

                        <div th:if="${not #lists.isEmpty(futureDefenses)}" class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Location</th>
                                        <th>Assigned Theses</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="defense : ${futureDefenses}">
                                        <td>
                                            <i class="bi bi-calendar3 me-2"></i>
                                            <span th:text="${#dates.format(defense.date, 'dd MMM yyyy')}">Date</span>
                                        </td>
                                        <td>
                                            <i class="bi bi-geo-alt me-2"></i>
                                            <span th:text="${defense.location}">Location</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info" th:text="${defense.sessionCount}">0</span>
                                            <span class="text-muted">theses assigned</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary assign-defense-btn" 
                                                    th:data-defense-id="${defense.id}"
                                                    th:data-defense-date="${#dates.format(defense.date, 'dd MMM yyyy')}">
                                                <i class="bi bi-plus-circle me-1"></i>Assign Thesis
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Scheduled Defense Sessions -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-calendar-event me-2"></i>Upcoming Defense Sessions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${#lists.isEmpty(futureDefenses)}" class="text-center py-4">
                            <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">No upcoming defense sessions scheduled yet.</p>
                        </div>
                        
                        <div th:if="${not #lists.isEmpty(futureDefenses)}"
                             th:with="hasAnySessions=${futureDefenses.?[not #lists.isEmpty(sessions)].size() > 0}">
                            <div th:if="${not hasAnySessions}" class="text-center py-4">
                                <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-2">No upcoming defense sessions scheduled yet.</p>
                            </div>
                            
                            <div th:if="${hasAnySessions}">
                                <div th:each="defense : ${futureDefenses}" th:if="${not #lists.isEmpty(defense.sessions)}">
                                <div class="card border-0 bg-light mb-3">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">
                                            <i class="bi bi-calendar-date me-2"></i>
                                            <span th:text="${#dates.format(defense.date, 'dd MMM yyyy')}"></span>
                                            - <span th:text="${defense.location}"></span>
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-sm mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Time</th>
                                                        <th>Student</th>
                                                        <th>Thesis Title</th>
                                                        <th>Supervisor</th>
                                                        <th>Defense Committee</th>
                                                        <th>Notes</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr th:each="defenseSession : ${defense.sessions}">
                                        <td>
                                            <strong th:text="${defenseSession.dateAndTime != null ? #temporals.format(defenseSession.dateAndTime, 'HH:mm') : 'TBD'}" 
                                                    class="text-primary"></strong>
                                        </td>
                                        <td>
                                            <span th:if="${defenseSession.thesis != null}" 
                                                  th:text="${defenseSession.thesis.studentFullName}">Student Name</span>
                                            <span th:if="${defenseSession.thesis == null}" class="text-muted">N/A</span>
                                        </td>
                                        <td>
                                            <span th:if="${defenseSession.thesis != null}" 
                                                  th:text="${defenseSession.thesis.proposalTitle}">Thesis Title</span>
                                            <span th:if="${defenseSession.thesis == null}" class="text-muted">N/A</span>
                                        </td>
                                        <td>
                                            <span th:if="${defenseSession.thesis != null}" 
                                                  th:text="${defenseSession.thesis.teacherFullName}">Supervisor</span>
                                            <span th:if="${defenseSession.thesis == null}" class="text-muted">N/A</span>
                                        </td>
                                        <td>
                                            <div th:if="${defenseSession.committeeMembers != null and not #lists.isEmpty(defenseSession.committeeMembers)}">
                                                <div th:each="member, iterStat : ${defenseSession.committeeMembers}">
                                                    <span class="badge bg-info me-1" th:text="${member}">Professor Name</span>
                                                    <br th:if="${not iterStat.last}">
                                                </div>
                                            </div>
                                            <div th:if="${defenseSession.committeeMembers == null or #lists.isEmpty(defenseSession.committeeMembers)}">
                                                <span class="badge bg-secondary">No Committee Assigned</span>
                                            </div>
                                        </td>
                                        <td>
                                            <small th:text="${defenseSession.notes ?: 'No notes'}" class="text-muted"></small>
                                        </td>
                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Theses Waiting for Defense -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-hourglass-split me-2"></i>Theses Waiting for Defense Assignment
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${#lists.isEmpty(waitingTheses)}" class="text-center py-4">
                            <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">No theses waiting for defense assignment.</p>
                        </div>

                        <div th:if="${not #lists.isEmpty(waitingTheses)}" class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Title</th>
                                        <th>Student</th>
                                        <th>Supervisor</th>
                                        <th>Department</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="thesis : ${waitingTheses}">
                                        <td>
                                            <strong th:text="${thesis.proposalTitle}">Thesis Title</strong>
                                        </td>
                                        <td>
                                            <span th:text="${thesis.studentFullName}">Student Name</span>
                                        </td>
                                        <td>
                                            <span th:text="${thesis.teacherFullName}">Teacher Name</span>
                                        </td>
                                        <td>
                                            <span th:text="${thesis.departmentName}">Department</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-success assign-thesis-btn" 
                                                    th:data-thesis-id="${thesis.id}">
                                                <i class="bi bi-calendar-plus me-1"></i>Assign to Defense
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Past Defense Sessions -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-clock-history me-2"></i>Past Defense Sessions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${#lists.isEmpty(pastDefenses)}" class="text-center py-4">
                            <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">No past defense sessions available.</p>
                        </div>
                        
                        <div th:if="${not #lists.isEmpty(pastDefenses)}">
                            <div class="accordion" id="pastDefensesAccordion">
                                <div th:each="defense, defStat : ${pastDefenses}" class="accordion-item">
                                    <h2 class="accordion-header" th:id="'heading-' + ${defStat.index}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                                th:data-bs-target="'#collapse-' + ${defStat.index}" aria-expanded="false" 
                                                th:aria-controls="'collapse-' + ${defStat.index}">
                                            <i class="bi bi-calendar3 me-2"></i>
                                            <span th:text="${#dates.format(defense.date, 'dd MMM yyyy')}">Date</span>
                                            - <span th:text="${defense.location}">Location</span>
                                            <span class="badge bg-secondary ms-3" th:text="${defense.sessionCount + ' sessions'}">0 sessions</span>
                                        </button>
                                    </h2>
                                    <div th:id="'collapse-' + ${defStat.index}" class="accordion-collapse collapse"
                                         th:aria-labelledby="'heading-' + ${defStat.index}" data-bs-parent="#pastDefensesAccordion">
                                        <div class="accordion-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-sm mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Time</th>
                                                            <th>Student</th>
                                                            <th>Thesis Title</th>
                                                            <th>Supervisor</th>
                                                            <th>Defense Committee</th>
                                                            <th>Notes</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr th:each="defenseSession : ${defense.sessions}">
                                                            <td>
                                                                <strong th:text="${defenseSession.dateAndTime != null ? #temporals.format(defenseSession.dateAndTime, 'HH:mm') : 'TBD'}" 
                                                                        class="text-primary"></strong>
                                                            </td>
                                                            <td>
                                                                <span th:if="${defenseSession.thesis != null}" 
                                                                    th:text="${defenseSession.thesis.studentFullName}">Student Name</span>
                                                                <span th:if="${defenseSession.thesis == null}" class="text-muted">N/A</span>
                                                            </td>
                                                            <td>
                                                                <span th:if="${defenseSession.thesis != null}" 
                                                                    th:text="${defenseSession.thesis.proposalTitle}">Thesis Title</span>
                                                                <span th:if="${defenseSession.thesis == null}" class="text-muted">N/A</span>
                                                            </td>
                                                            <td>
                                                                <span th:if="${defenseSession.thesis != null}" 
                                                                    th:text="${defenseSession.thesis.teacherFullName}">Supervisor</span>
                                                                <span th:if="${defenseSession.thesis == null}" class="text-muted">N/A</span>
                                                            </td>
                                                            <td>
                                                                <div th:if="${defenseSession.committeeMembers != null and not #lists.isEmpty(defenseSession.committeeMembers)}">
                                                                    <div th:each="member, iterStat : ${defenseSession.committeeMembers}">
                                                                        <span class="badge bg-info me-1" th:text="${member}">Professor Name</span>
                                                                        <br th:if="${not iterStat.last}">
                                                                    </div>
                                                                </div>
                                                                <div th:if="${defenseSession.committeeMembers == null or #lists.isEmpty(defenseSession.committeeMembers)}">
                                                                    <span class="badge bg-secondary">No Committee Assigned</span>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <small th:text="${defenseSession.notes ?: 'No notes'}" class="text-muted"></small>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Assign Thesis Modal -->
    <div class="modal fade" id="assignThesisModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Thesis to Defense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/dashboard/defences/assign-thesis}" method="post">
                    <div class="modal-body">
                        <div id="defense-selection" class="mb-3">
                            <label for="modalDefenseSelect" class="form-label">Select Defense Date</label>
                            <select class="form-select" id="modalDefenseSelect" name="defenseId" required>
                                <option value="">Choose a defense date...</option>
                                <option th:each="defense : ${futureDefenses}" 
                                        th:value="${defense.id}" 
                                        th:text="${#dates.format(defense.date, 'dd MMM yyyy') + ' - ' + defense.location}">
                                    Defense Date
                                </option>
                            </select>
                        </div>
                        
                        <div id="thesis-selection" class="mb-3">
                            <label for="modalThesisSelect" class="form-label">Select Thesis</label>
                            <select class="form-select" id="modalThesisSelect" name="thesisId" required>
                                <option value="">Choose a thesis...</option>
                                <option th:each="thesis : ${waitingTheses}" 
                                        th:value="${thesis.id}" 
                                        th:text="${thesis.proposalTitle + ' (' + thesis.studentFullName + ')'}">
                                    Thesis Title
                                </option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="modalDefenseTime" class="form-label">Defense Time <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="modalDefenseTime" name="defenseTime" required>
                            <div class="form-text">Select the time for this thesis defense on the chosen defense date</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="modalNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="modalNotes" name="notes" rows="3" 
                                      placeholder="Any special notes or requirements for this defense session..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="modalProfessors" class="form-label">Defense Committee Professors <span class="text-danger">*</span></label>
                            <select class="form-select" id="modalProfessors" name="professorIds" multiple required>
                                <option th:each="teacher : ${teachers}" 
                                        th:value="${teacher.id}" 
                                        th:text="${teacher.firstName + ' ' + teacher.lastName + ' (' + teacher.email + ')'}">
                                    Professor Name
                                </option>
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple professors for the defense committee</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Assign Thesis
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showAssignThesisModal(defenseId, defenseDate, thesisId) {
            const modal = new bootstrap.Modal(document.getElementById('assignThesisModal'));
            const defenseSelect = document.getElementById('modalDefenseSelect');
            const thesisSelect = document.getElementById('modalThesisSelect');
            const timeInput = document.getElementById('modalDefenseTime');
            
            // Reset selections
            defenseSelect.value = '';
            thesisSelect.value = '';
            timeInput.value = '';
            
            // Pre-select defense if provided
            if (defenseId) {
                defenseSelect.value = defenseId;
            }
            
            // Pre-select thesis if provided  
            if (thesisId) {
                thesisSelect.value = thesisId;
            }
            
            modal.show();
        }
        
        // Add event listeners for assign thesis buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Handle assign thesis from waiting list
            const assignButtons = document.querySelectorAll('.assign-thesis-btn');
            assignButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const thesisId = this.getAttribute('data-thesis-id');
                    showAssignThesisModal(null, null, thesisId);
                });
            });
            
            // Handle assign thesis to defense date
            const assignDefenseButtons = document.querySelectorAll('.assign-defense-btn');
            assignDefenseButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const defenseId = this.getAttribute('data-defense-id');
                    const defenseDate = this.getAttribute('data-defense-date');
                    showAssignThesisModal(defenseId, defenseDate, null);
                });
            });
        });
    </script>
    
    </main>
    </div>
    
    <!-- Footer -->
    <footer th:replace="~{fragments/layout :: footer}"></footer>
    
    <!-- Scripts -->
    <script th:replace="~{fragments/layout :: scripts}"></script>
</body>
</html>
